# File: .github/workflows/amplify-deploy.yml
name: Amplify Deploy

on:
  push:
    branches: [ dev, staging, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Install Amplify CLI
      run: npm install -g @aws-amplify/cli

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Build Web
      run: flutter build web

    - name: Deploy to Amplify
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ap-southeast-1
      run: |
        BRANCH_NAME=${GITHUB_REF##*/}
        echo "Current branch: $BRANCH_NAME"
        
        # Pull the latest backend environment
        amplify pull --appId ${{ secrets.AMPLIFY_APP_ID }} --envName $BRANCH_NAME --yes
        
        # Manually add hosting configuration
        mkdir -p amplify/backend/hosting/S3AndCloudFront
        cat << EOF > amplify/backend/hosting/S3AndCloudFront/parameters.json
        {
            "bucketName": "weberbrain-$BRANCH_NAME-$(date +%s)"
        }
        EOF
        
        # Update amplify-meta.json
        jq '.hosting.S3AndCloudFront = {"service": "S3AndCloudFront", "providerPlugin": "awscloudformation", "dependsOn": []}' amplify/backend/amplify-meta.json > temp.json && mv temp.json amplify/backend/amplify-meta.json
        
        # Copy the build output to the Amplify build directory
        mkdir -p amplify/backend/hosting/S3AndCloudFront/build
        cp -R build/web/* amplify/backend/hosting/S3AndCloudFront/build/
        
        # Publish
        echo "Publishing..."
        amplify publish --yes
        
        echo "Deployment completed successfully."